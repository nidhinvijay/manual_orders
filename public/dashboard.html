<!DOCTYPE html>
<html>

<head>
  <title>Options Dashboard</title>
  <script src="/socket.io/socket.io.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      text-align: center;
      padding: 20px;
      background: #f5f5f5;
    }

    table {
      margin: 20px auto;
      border-collapse: collapse;
      background: white;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    th,
    td {
      padding: 10px 12px;
      border: 1px solid #ddd;
    }

    th {
      background: #333;
      color: white;
    }

    input[type="number"] {
      width: 60px;
      padding: 4px;
      border: 1px solid #ccc;
      border-radius: 4px;
    }

    button {
      padding: 6px 12px;
      margin: 2px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }

    .btn-buy {
      background: #28a745;
      color: white;
    }

    .btn-sell {
      background: #dc3545;
      color: white;
    }

    .btn-edit {
      background: #007bff;
      color: white;
    }

    .btn-save {
      background: #17a2b8;
      color: white;
    }

    button:disabled {
      background: #ccc;
      cursor: not-allowed;
    }

    .pnl-positive {
      color: green;
      font-weight: bold;
    }

    .pnl-negative {
      color: red;
      font-weight: bold;
    }

    .mode-sim {
      color: orange;
      font-weight: bold;
    }

    .mode-live {
      color: green;
      font-weight: bold;
    }

    .sl-tp-cell {
      font-size: 12px;
    }

    .sl-value {
      color: #dc3545;
    }

    .tp-value {
      color: #28a745;
    }

    #connection {
      margin-top: 5px;
      font-size: 12px;
    }

    .alert-popup {
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 15px 25px;
      border-radius: 8px;
      color: white;
      font-weight: bold;
      z-index: 1000;
      animation: slideIn 0.3s ease;
    }

    .alert-stoploss {
      background: #dc3545;
    }

    .alert-takeprofit {
      background: #28a745;
    }

    .alert-error {
      background: #fd7e14;
    }

    @keyframes slideIn {
      from {
        transform: translateX(100%);
        opacity: 0;
      }

      to {
        transform: translateX(0);
        opacity: 1;
      }
    }
  </style>
</head>

<body>
  <h2>Live Options Dashboard</h2>

  <div style="margin-bottom: 20px;">
    <a href="instruments.html">Instruments</a> |
    <a href="accounts.html">Accounts</a>
  </div>

  <div id="mode" style="margin-bottom:10px;font-weight:bold"></div>
  <button onclick="toggleMode()">Toggle SIM / LIVE</button>
  <div id="connection"></div>

  <div id="alerts"></div>

  <table>
    <thead>
      <tr>
        <th>Symbol</th>
        <th>LTP</th>
        <th>Lot</th>
        <th>Entry</th>
        <th>SL</th>
        <th>TP</th>
        <th>PnL</th>
        <th>Action</th>
      </tr>
    </thead>
    <tbody id="rows"></tbody>
  </table>

  <h3>Trade History</h3>
  <table>
    <thead>
      <tr>
        <th>Symbol</th>
        <th>Entry</th>
        <th>Exit</th>
        <th>Lot</th>
        <th>PnL</th>
        <th>Mode</th>
        <th>Exit Reason</th>
        <th>Account</th>
        <th>Timestamp</th>
      </tr>
    </thead>
    <tbody id="trades"></tbody>
  </table>

  <script>
    const socket = io()

    let instruments = []
    let state = {}
    let trades = []
    let executionMode = "SIM"
    let editingToken = null  // Track which row is being edited

    // Connection status
    socket.on("connect", () => {
      document.getElementById("connection").innerHTML = "ðŸŸ¢ Connected"
      document.getElementById("connection").style.color = "green"
    })

    socket.on("disconnect", () => {
      document.getElementById("connection").innerHTML = "ðŸ”´ Disconnected"
      document.getElementById("connection").style.color = "red"
    })

    // Socket.IO event handlers
    socket.on("state", (s) => {
      state = s
      renderPositions()
    })

    socket.on("mode", (m) => {
      executionMode = m.execution_mode
      document.getElementById("mode").innerText = "Execution Mode: " + executionMode
    })

    socket.on("ltp", (updates) => {
      updates.forEach(u => {
        if (state[u.token]) {
          state[u.token].ltp = u.ltp
        } else {
          state[u.token] = { ltp: u.ltp }
        }
      })
      // Only update LTP and PnL cells, don't re-render entire table
      updateLtpCells()
    })

    socket.on("position", (data) => {
      state[data.token] = data.state
      renderPositions()
    })

    socket.on("trade", (trade) => {
      trades.push(trade)
      renderTrades()
    })

    // Alert handler
    socket.on("alert", (alert) => {
      showAlert(alert)
    })

    function showAlert(alert) {
      const alertsDiv = document.getElementById("alerts")
      const alertEl = document.createElement("div")
      alertEl.className = `alert-popup alert-${alert.type.toLowerCase()}`
      alertEl.innerText = alert.message
      alertsDiv.appendChild(alertEl)

      // Auto-remove after 5 seconds
      setTimeout(() => {
        alertEl.remove()
      }, 5000)
    }

    // Initial data load
    async function loadInstruments() {
      const r = await fetch("/instruments/selected")
      instruments = await r.json()
      renderPositions()
    }

    async function loadTrades() {
      const r = await fetch("/trades")
      trades = await r.json()
      renderTrades()
    }

    async function loadMode() {
      const r = await fetch("/mode")
      const d = await r.json()
      executionMode = d.execution_mode
      document.getElementById("mode").innerText = "Execution Mode: " + executionMode
    }

    async function buy(token) {
      const slInput = document.getElementById(`sl-input-${token}`)
      const tpInput = document.getElementById(`tp-input-${token}`)

      const stoploss = slInput?.value || null
      const takeprofit = tpInput?.value || null

      const res = await fetch("/buy", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ instrumentToken: token, stoploss, takeprofit })
      })

      const data = await res.json()

      if (!data.results) {
        alert("Order failed")
        return
      }

      let msg = "BUY RESULTS:\n\n"
      data.results.forEach(r => {
        if (r.result?.status === "success") {
          msg += `âœ” ${r.account}\n`
        } else {
          msg += `âœ– ${r.account} â†’ ${r.result?.message || "failed"}\n`
        }
      })

      alert(msg)
    }

    async function sell(token) {
      const res = await fetch("/sell", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ token })
      })

      const data = await res.json()

      if (!data.results) {
        alert("Sell failed")
        return
      }

      let msg = "SELL RESULTS:\n\n"
      data.results.forEach(r => {
        if (r.result?.status === "success") {
          msg += `âœ” ${r.account}\n`
        } else {
          msg += `âœ– ${r.account} â†’ ${r.result?.message || "failed"}\n`
        }
      })

      alert(msg)
    }

    function startEdit(token) {
      editingToken = token
      renderPositions()
    }

    function cancelEdit() {
      editingToken = null
      renderPositions()
    }

    async function saveSLTP(token) {
      const slInput = document.getElementById(`sl-edit-${token}`)
      const tpInput = document.getElementById(`tp-edit-${token}`)

      const stoploss = slInput?.value || null
      const takeprofit = tpInput?.value || null

      await fetch("/position/sltp", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ token, stoploss, takeprofit })
      })

      editingToken = null
      // Position update will come via socket
    }

    function renderPositions() {
      const rowsEl = document.getElementById("rows")
      rowsEl.innerHTML = ""

      instruments.forEach(i => {
        const s = state[i.token] || {}
        const ltp = s.ltp || 0

        // Find any account with a buy position
        const accountKey = Object.keys(s).find(k => k !== "ltp" && s[k]?.buyposition)
        const pos = accountKey ? s[accountKey] : {}
        const entry = pos.entry || 0
        const buyposition = pos.buyposition
        const sl = pos.stoploss
        const tp = pos.takeprofit

        const pnl = buyposition ? (ltp - entry) * i.lot : 0
        const pnlClass = pnl >= 0 ? "pnl-positive" : "pnl-negative"

        const isEditing = editingToken === i.token && buyposition

        const tr = document.createElement("tr")
        tr.setAttribute("data-row-token", i.token)

        if (buyposition) {
          // Active position row
          if (isEditing) {
            // Editing mode
            tr.innerHTML = `
              <td>${i.symbol}</td>
              <td data-ltp="${i.token}">${ltp.toFixed(2)}</td>
              <td>${i.lot}</td>
              <td>${entry.toFixed(2)}</td>
              <td><input type="number" id="sl-edit-${i.token}" value="${sl || ''}" placeholder="SL" step="0.05"></td>
              <td><input type="number" id="tp-edit-${i.token}" value="${tp || ''}" placeholder="TP" step="0.05"></td>
              <td data-pnl="${i.token}" data-entry="${entry}" class="${pnlClass}">${pnl.toFixed(2)}</td>
              <td>
                <button class="btn-save" onclick="saveSLTP(${i.token})">Save</button>
                <button onclick="cancelEdit()">Cancel</button>
              </td>
            `
          } else {
            // Display mode
            const slDisplay = sl !== null && sl !== undefined ? `<span class="sl-value">${sl.toFixed(2)}</span>` : '--'
            const tpDisplay = tp !== null && tp !== undefined ? `<span class="tp-value">${tp.toFixed(2)}</span>` : '--'

            tr.innerHTML = `
              <td>${i.symbol}</td>
              <td data-ltp="${i.token}">${ltp.toFixed(2)}</td>
              <td>${i.lot}</td>
              <td>${entry.toFixed(2)}</td>
              <td class="sl-tp-cell">${slDisplay}</td>
              <td class="sl-tp-cell">${tpDisplay}</td>
              <td data-pnl="${i.token}" data-entry="${entry}" class="${pnlClass}">${pnl.toFixed(2)}</td>
              <td>
                <button class="btn-edit" onclick="startEdit(${i.token})">Edit</button>
                <button class="btn-sell" onclick="sell(${i.token})">Sell</button>
              </td>
            `
          }
        } else {
          // No position - show buy inputs
          tr.innerHTML = `
            <td>${i.symbol}</td>
            <td data-ltp="${i.token}">${ltp.toFixed(2)}</td>
            <td>${i.lot}</td>
            <td>--</td>
            <td><input type="number" id="sl-input-${i.token}" placeholder="SL" step="0.05"></td>
            <td><input type="number" id="tp-input-${i.token}" placeholder="TP" step="0.05"></td>
            <td>--</td>
            <td>
              <button class="btn-buy" onclick="buy(${i.token})">Buy</button>
            </td>
          `
        }

        rowsEl.appendChild(tr)
      })
    }

    // Update only LTP and PnL cells without re-rendering the table
    function updateLtpCells() {
      instruments.forEach(i => {
        const s = state[i.token] || {}
        const ltp = s.ltp || 0

        // Update LTP cell
        const ltpCell = document.querySelector(`[data-ltp="${i.token}"]`)
        if (ltpCell) {
          ltpCell.textContent = ltp.toFixed(2)
        }

        // Update PnL cell if exists
        const pnlCell = document.querySelector(`[data-pnl="${i.token}"]`)
        if (pnlCell) {
          const entry = parseFloat(pnlCell.getAttribute("data-entry")) || 0
          const inst = instruments.find(inst => inst.token === i.token)
          if (inst && entry > 0) {
            const pnl = (ltp - entry) * inst.lot
            pnlCell.textContent = pnl.toFixed(2)
            pnlCell.className = pnl >= 0 ? "pnl-positive" : "pnl-negative"
          }
        }
      })
    }

    function renderTrades() {
      const tradesEl = document.getElementById("trades")
      tradesEl.innerHTML = ""

      // Show newest first
      const sortedTrades = [...trades].reverse()

      sortedTrades.forEach(t => {
        const pnlClass = t.pnl >= 0 ? "pnl-positive" : "pnl-negative"
        const modeClass = t.mode === "LIVE" ? "mode-live" : "mode-sim"

        const dt = new Date(t.timestamp)
        const ist = new Date(dt.getTime() + 5.5 * 60 * 60 * 1000)
        const istStr = ist.toISOString().replace("T", " ").split(".")[0]

        const exitReason = t.exit_reason || "MANUAL"
        const reasonClass = exitReason === "STOPLOSS" ? "pnl-negative" :
          exitReason === "TAKEPROFIT" ? "pnl-positive" : ""

        const tr = document.createElement("tr")
        tr.innerHTML = `
          <td>${t.symbol}</td>
          <td>${t.entry.toFixed(2)}</td>
          <td>${t.exit.toFixed(2)}</td>
          <td>${t.lot}</td>
          <td class="${pnlClass}">${t.pnl.toFixed(2)}</td>
          <td class="${modeClass}">${t.mode}</td>
          <td class="${reasonClass}">${exitReason}</td>
          <td>${t.account || "-"}</td>
          <td>${istStr}</td>
        `
        tradesEl.appendChild(tr)
      })
    }

    async function toggleMode() {
      const newMode = executionMode === "SIM" ? "LIVE" : "SIM"
      await fetch("/mode", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ execution_mode: newMode })
      })
    }

    async function start() {
      await loadInstruments()
      await loadMode()
      await loadTrades()
    }

    start()
  </script>
</body>

</html>