<!DOCTYPE html>
<html>

<head>
  <title>Options Dashboard</title>
  <script src="/socket.io/socket.io.js"></script>
</head>

<body style="font-family: Arial, sans-serif; text-align: center; padding: 20px;">

  <h2>Live Options Dashboard</h2>

  <!-- Navigation Links -->
  <div style="margin-bottom: 20px;">
    <a href="instruments.html">Instruments</a> |
    <a href="accounts.html">Accounts</a>
  </div>

  <div id="mode" style="margin-bottom:10px;font-weight:bold"></div>
  <button onclick="toggleMode()">Toggle SIM / LIVE</button>
  <div id="connection" style="margin-top:5px;font-size:12px;color:gray"></div>

  <!-- Live Positions Table -->
  <table border="1" cellpadding="8" cellspacing="0"
    style="margin: 20px auto; border-collapse: collapse; text-align: center;">
    <thead>
      <tr style="background-color: #eee;">
        <th>Symbol</th>
        <th>LTP</th>
        <th>Lot</th>
        <th>Qty</th>
        <th>Entry</th>
        <th>PnL</th>
        <th>Action</th>
      </tr>
    </thead>
    <tbody id="rows"></tbody>
  </table>

  <h3>Trade History</h3>
  <table border="1" cellpadding="6" cellspacing="0"
    style="margin: 0 auto; border-collapse: collapse; text-align: center;">
    <thead>
      <tr style="background-color: #eee;">
        <th>Symbol</th>
        <th>Entry</th>
        <th>Exit</th>
        <th>Lot</th>
        <th>PnL</th>
        <th>Mode</th>
        <th>Account</th>
        <th>Timestamp</th>
      </tr>
    </thead>
    <tbody id="trades"></tbody>
  </table>

  <script>
    // Socket.IO connection
    const socket = io()

    let instruments = []
    let state = {}
    let trades = []
    let executionMode = "SIM"

    // Connection status
    socket.on("connect", () => {
      document.getElementById("connection").innerText = "ðŸŸ¢ Connected"
      document.getElementById("connection").style.color = "green"
    })

    socket.on("disconnect", () => {
      document.getElementById("connection").innerText = "ðŸ”´ Disconnected"
      document.getElementById("connection").style.color = "red"
    })

    // Socket.IO event handlers
    socket.on("state", (s) => {
      state = s
      renderPositions()
    })

    socket.on("mode", (m) => {
      executionMode = m.execution_mode
      document.getElementById("mode").innerText = "Execution Mode: " + executionMode
    })

    socket.on("ltp", (updates) => {
      updates.forEach(u => {
        if (state[u.token]) {
          state[u.token].ltp = u.ltp
        } else {
          state[u.token] = { ltp: u.ltp }
        }
      })
      renderPositions()
    })

    socket.on("position", (data) => {
      state[data.token] = data.state
      renderPositions()
    })

    socket.on("trade", (trade) => {
      trades.push(trade)
      renderTrades()
    })

    // Initial data load (one-time, not polling)
    async function loadInstruments() {
      const r = await fetch("/instruments/selected")
      instruments = await r.json()
      renderPositions()
    }

    async function loadTrades() {
      const r = await fetch("/trades")
      trades = await r.json()
      renderTrades()
    }

    async function loadMode() {
      const r = await fetch("/mode")
      const d = await r.json()
      executionMode = d.execution_mode
      document.getElementById("mode").innerText = "Execution Mode: " + executionMode
    }

    async function buy(token) {
      const res = await fetch("/buy", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ instrumentToken: token })
      })

      const data = await res.json()

      if (!data.results) {
        alert("Order failed")
        return
      }

      let msg = "BUY RESULTS:\n\n"
      data.results.forEach(r => {
        if (r.result?.status === "success") {
          msg += `âœ” ${r.account}\n`
        } else {
          msg += `âœ– ${r.account} â†’ ${r.result?.message || "failed"}\n`
        }
      })

      alert(msg)
    }

    async function sell(token) {
      const res = await fetch("/sell", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ token })
      })

      const data = await res.json()

      if (!data.results) {
        alert("Sell failed")
        return
      }

      let msg = "SELL RESULTS:\n\n"
      data.results.forEach(r => {
        if (r.result?.status === "success") {
          msg += `âœ” ${r.account}\n`
        } else {
          msg += `âœ– ${r.account} â†’ ${r.result?.message || "failed"}\n`
        }
      })

      alert(msg)
    }

    function renderPositions() {
      const rowsEl = document.getElementById("rows")
      rowsEl.innerHTML = ""
      instruments.forEach(i => {
        const s = state[i.token] || {}
        const ltp = s.ltp || 0

        // Find any account with a buy position
        const accountKey = Object.keys(s).find(k => k !== "ltp" && s[k].buyposition)
        const pos = accountKey ? s[accountKey] : {}
        const entry = pos.entry || 0
        const buyposition = pos.buyposition

        const pnl = buyposition ? (ltp - entry) * i.lot : 0
        const pnlColor = pnl >= 0 ? "green" : "red"

        const sellDisabled = !buyposition ? "disabled" : ""
        const tr = document.createElement("tr")
        tr.innerHTML = `
      <td>${i.symbol}</td>
      <td>${ltp.toFixed(2)}</td>
      <td>${i.lot}</td>
      <td>${i.lot}</td>
      <td>${entry.toFixed(2)}</td>
      <td style="color: ${pnlColor}; font-weight: bold;">${pnl.toFixed(2)}</td>
      <td>
        <button onclick="buy(${i.token})">Buy</button>
        <button onclick="sell(${i.token})" ${sellDisabled}>Sell</button>
      </td>
    `
        rowsEl.appendChild(tr)
      })
    }

    function renderTrades() {
      const tradesEl = document.getElementById("trades")
      tradesEl.innerHTML = ""

      trades.forEach(t => {
        const pnlColor = t.pnl >= 0 ? "green" : "red"
        const modeColor = t.mode === "LIVE" ? "green" : "orange"

        const dt = new Date(t.timestamp)
        const ist = new Date(dt.getTime() + 5.5 * 60 * 60 * 1000)
        const istStr = ist.toISOString().replace("T", " ").split(".")[0]

        const tr = document.createElement("tr")
        tr.innerHTML = `
          <td>${t.symbol}</td>
          <td>${t.entry.toFixed(2)}</td>
          <td>${t.exit.toFixed(2)}</td>
          <td>${t.lot}</td>
          <td style="color:${pnlColor};font-weight:bold">${t.pnl.toFixed(2)}</td>
          <td style="color:${modeColor};font-weight:bold">${t.mode}</td>
          <td>${t.account || "-"}</td>
          <td>${istStr}</td>
        `
        tradesEl.appendChild(tr)
      })
    }

    async function toggleMode() {
      const newMode = executionMode === "SIM" ? "LIVE" : "SIM"
      await fetch("/mode", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ execution_mode: newMode })
      })
      // Mode will be updated via socket.on("mode")
    }

    // Start - load initial data once
    async function start() {
      await loadInstruments()
      await loadMode()
      await loadTrades()
    }

    start()
  </script>
</body>

</html>